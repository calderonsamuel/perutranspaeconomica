---
title: "Elección de parámetros"
author: "Samuel Calderon"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{elegir-parametros}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, include=FALSE}
library(DiagrammeR)

add_starter_node <- function(graph, label) {
    add_node(
        graph = graph, 
        label = stringr::str_wrap(label, 12), 
        node_aes = node_aes(shape = "circle", fontsize = 5)
    )
}

add_custom_node <- function(graph, label, type = NULL) {
    add_node(
        graph = graph, 
        label = stringr::str_wrap(label, 12), 
        node_aes = node_aes(shape = "rectangle", fontsize = 5), 
        type = type
    )
}

add_custom_edge <- function(graph, from, to) {
    add_edge(
        graph = graph,
        from = stringr::str_wrap(from, 12),
        to = stringr::str_wrap(to, 12), 
    )
}
```

A pesar de que este paquete brinda una manera de interactuar con la plataforma de seguimiento a la ejecución presupuestal, es necesario mencionar que yo (el autor del paquete) no he tenido ningún tipo de participación en el diseño, programación o mantenimiento de la plataforma del MEF. La plataforma no parece haber sido diseñada pensando en consultas fuera de su interfaz gráfica, que protege al usuario típico de tener que conocer las maneras tan distintas en que se definen sus parámetros, tanto en sus nombres como en sus valores esperados.

Pero si estás leyendo esto significa que la interfaz definida por el equipo del MEF no es suficiente para tus propósitos, y tienes la disposición necesaria para invertir un poco de esfuerzo para obtener la gran recompensa de aprovechar de manera más eficiente la información de la plataforma. Siéntete libre de consultar este documento cuantas veces sea necesario.

## El flujo de trabajo

Como pasa con cualquier paquete en R, para usarlo debemos cargarlo.

```{r setup}
library(perutranspaeconomica)
```

El flujo de trabajo propuesto por `{perutranspaeconomica}` consiste en:

1.  Iniciar
2.  Elegir
3.  Consultar

Por lo pronto, iniciar no requiere más trabajo que el uso de `seguimiento_ep()`. Este documento busca explicar con mayor detalle la manera en que se deben definir los parámetros pasados a las funciones `elegir_*()` para, en combinación con `consultar()`, poder hacer consultas exitosas.

La interacción con el sistema del MEF es mejor aprovechable si se tienen conocimientos acerca de Sistema Nacional de Presupuesto Público. Para ello, recomiendo la lectura del [Decreto Legislativo Nº 1440 Decreto Legislativo del Sistema Nacional de Presupuesto Público](https://www.gob.pe/institucion/mef/normas-legales/201360-1440). En especial del sub capítulo II y III.

## Funciones de elección

El paquete permite especificar todas las consultas que se pueden hacer desde la plataforma del MEF, del 2012 en adelante. A continuación se explica cómo definir cada uno de los parámetros. En todos los casos se hará uso de `consultar()` para ver la tabla consultada.

### Elegir periodo anual

Para esto usamos `elegir_periodo_anual()`. Toda consulta requiere que se defina el periodo anual. Cuando no se especifica ningún año dentro de esta función, se usa por defecto el año en curso.

```{r}
seguimiento_ep() |> 
    elegir_periodo_anual() |> 
    consultar()
```

Debido a que no estamos especificando ningún otro parámetro aún, `consultar()` nos devuelve los datos del presupuesto total. Es la misma información que se obtiene al ingresar a la plataforma de manera normal.

Es posible especificar más de un año de consulta. Para ello basta con especificar un vector numérico con los años que nos interesan.

```{r}
seguimiento_ep() |> 
    elegir_periodo_anual(c(2012, 2014, 2016)) |> 
    consultar()
```

Cada sección que viene a continuación muestra un tipo de elección de detalle con uno o dos gráficos que explican la posible *ruta* tomando en cuenta los argumentos de la consulta. Al terminar de repasar cada tipo de elección se aclarará a qué se hace referencia con "Consulta base".

### Elegir quién gasta

Esta función permite buscar la información de ejecución presupuestal según el tipo de entidad que queremos consultar. En su grado más alto de especificidad se puede llegar a diferenciar según Unidad Ejecutora, Municipio o Mancomunidad. El gráfico muestra todos los elementos de consulta intermedios a los que se puede acceder. Debe tenerse en cuenta que una vez tomada una "ruta" de consulta no es posible acceder a otra. Por ejemplo, no es posible consultar por pliego y departamento al mismo tiempo.

```{r, echo=FALSE}
graph_quien_gasta <- create_graph(attr_theme = "lr") |> 
    add_starter_node(label = "Consulta base") |> 
    add_custom_node(label = "Nivel de gobierno") |> 
    add_custom_node(label = "Sector") |> 
    add_custom_node(label = "Gob local o mancomunidad") |> 
    add_custom_node(label = "Pliego") |> 
    add_custom_node(label = "Unidad ejecutora") |> 
    add_custom_node(label = "Departamento") |> 
    add_custom_node(label = "Mancomunidad") |> 
    add_custom_node(label = "Provincia") |> 
    add_custom_node(label = "Municipalidad") |> 
    add_custom_edge(from = "Consulta base", to = "Nivel de gobierno") |>
    add_custom_edge(from = "Nivel de gobierno", to = "Sector") |>
    add_custom_edge(from = "Nivel de gobierno", to = "Gob local o mancomunidad") |>
    add_custom_edge(from = "Sector", to = "Pliego") |> 
    add_custom_edge(from = "Pliego", to = "Unidad ejecutora") |> 
    add_custom_edge(from = "Gob local o mancomunidad", to = "Departamento") |> 
    add_custom_edge(from = "Gob local o mancomunidad", to = "Mancomunidad") |> 
    add_custom_edge(from = "Departamento", to = "Provincia") |> 
    add_custom_edge(from = "Departamento", to = "Municipalidad") |> 
    add_custom_edge(from = "Provincia", to = "Municipalidad") |> 
    render_graph()

graph_quien_gasta
```

A manera de ejemplo, si quisiéramos ver todos los niveles de gobierno disponibles lo especificamos en el argumento `nivel`. Recuerda que siempre es necesario usar `elegir_periodo_anual()`.

```{r}
seguimiento_ep() |> 
    elegir_periodo_anual() |> 
    elegir_quien_gasta(nivel = "todos") |> 
    consultar()
```

Con esto podemos ver que existen tres niveles de gobierno. En caso se escoja profundizar la consulta por Gobierno Nacional o Gobiernos Regionales se estaría tomando el camino de Sector. En este caso, escogemos Gobierno Nacional para ver el presupuesto por sector. Para ello, usamos el código del nivel de gobierno escogido. Nótese que para mayor comodidad en el procesamiento de los datos, se incluyen columnas extras con la metadata de la consulta.

```{r}
seguimiento_ep() |> 
    elegir_periodo_anual() |> 
    elegir_quien_gasta(nivel = "E", sector = "todos") |> 
    consultar()
```

Ahora que se sabe cuáles son los sectores que conforman al gobierno nacional, podemos priorizar conocer la ejecución de alguno en específico. Por ejemplo, el sector salud. Para ello, actualizamos nuestros parámetros de búsqueda indicando el código del sector correspondiente y especificando conocer todos los pliegos que lo conforman.

```{r}
seguimiento_ep() |> 
    elegir_periodo_anual() |> 
    elegir_quien_gasta(nivel = "E", sector = "11", pliego = "todos") |> 
    consultar()
```

Con esto, ahora podemos ver que el sector salud está conformado por cinco pliegos. Puede que ahora querramos ver los datos de las unidades ejecutoras del Ministerio de salud. Nuevamente, especificamos esto en la consulta.

```{r}
seguimiento_ep() |> 
    elegir_periodo_anual() |> 
    elegir_quien_gasta(nivel = "E", sector = "11", pliego = "011", unidad_ejecutora = "todos") |> 
    consultar()
```

Este ha sido el nivel de detalle más profundo que brinda la consulta por esta ruta. El ejercicio es muy similar si se quiere obtener los datos por municipio. Por ejemplo, para conocer los datos de los distritos de la provincia de Cangallo, región Ayacucho.

```{r}
seguimiento_ep() |> 
    elegir_periodo_anual() |> 
    elegir_quien_gasta(nivel = "M", goblocal_o_manc = "M", departamento = "05", provincia = "02", municipalidad = "todos") |> 
    consultar()
```

### Elegir en qué se gasta

Para esta consulta hace falta encadenar la función `elegir_en_que_se_gasta()`. El sistema de consulta amigable del MEF hace pensar que

```{r}
presupuestarios <- c("Categoría Presupuestal", "Producto o proyecto", "Actividad o acción de inversión u obra")
funcionales <- c("Función", "División funcional", "Grupo funcional", "Meta")

en_que_se_gasta_nodes <- create_node_df(
    # id = 1:3,
    n = 7,
    label = c(presupuestarios, funcionales) |> stringr::str_wrap(12),
    cluster = rep("Parámetros Presupuestarios", 3) |> c(rep("Funcionales", 4)),
    shape = "rectangle", 
    fontsize = 5
) #|> 
    # dplyr::mutate(label = stringr::str_wrap(label, 12))

en_que_se_gasta_edges <- create_edge_df(
    from = c(1, 2, 4, 5, 6),
    to = c(2, 3, 5, 6, 7)
)

en_que_se_gasta_graph <- create_graph(attr_theme = "lr", nodes_df = en_que_se_gasta_nodes, edges_df = en_que_se_gasta_edges)
```

```{r, eval=FALSE}
create_graph(attr_theme = "lr") |> 
    add_starter_node("Consulta base") |> 
    combine_graphs(en_que_se_gasta_graph) |> 
    add_edge(1, 2) |>
    add_edge(1, 5) |>
    add_node(label = "invisible", ) |> 
    add_custom_edge(from = "Categoría Presupuestal", to = "invisible") |>
    add_custom_edge(from = "Producto o proyecto", to = "invisible") |>
    add_custom_edge(from = "Actividad o acción de inversión u obra", to = "invisible") |>
    add_custom_edge(from = "Función", to =  "invisible") |>
    add_custom_edge(from = "División funcional", to =  "invisible") |>
    add_custom_edge(from = "Grupo funcional", to =  "invisible") |>
    add_custom_edge(from = "Meta", to =  "invisible") |>
    # add_edge(2, 5) |> 
    # add_edge(3, 5) |> 
    # add_edge(4, 5) |> 
    # add_edge(5, 2) |> 
    # add_edge(6, 2) |> 
    # add_edge(7, 2) |> 
    # add_edge(8, 2) |> 
    render_graph()
```

```{r}
graph1 <- create_graph(attr_theme = "lr") |> 
    add_custom_node("Categoría Presupuestal", type = "A") |> 
    add_custom_node("Producto o proyecto", type = "A") |> 
    add_custom_node("Actividad o acción de inversión u obra", type = "A") |> 
    add_starter_node("Consulta base") |> 
    add_custom_edge(from = "Consulta base", to = "Categoría Presupuestal") |> 
    add_custom_edge(from = "Categoría Presupuestal", to = "Producto o proyecto") |> 
    add_custom_edge(from = "Producto o proyecto", to = "Actividad o acción de inversión u obra")

render_graph(graph1)
```

```{r}
graph2 <- create_graph(attr_theme = "lr") |> 
    add_custom_node("Función") |> 
    add_custom_node("División funcional") |> 
    add_custom_node("Grupo funcional") |> 
    add_custom_node("Meta") |> 
    add_starter_node("Consulta base") |> 
    add_custom_edge(from = "Consulta base", to = "Función") |> 
    add_custom_edge(from = "Función", to = "División funcional") |> 
    add_custom_edge(from = "División funcional", to = "Grupo funcional") |> 
    add_custom_edge(from = "Grupo funcional", to = "Meta")

render_graph(graph2)
```

### Elegir con qué se financian los gastos

```{r}
create_graph(attr_theme = "lr") |> 
    add_starter_node("Consulta base") |> 
    add_custom_node("Fuente de financiamiento") |> 
    add_custom_node("Rubro") |> 
    add_custom_node("Tipo de recurso") |> 
    add_custom_edge(from = "Consulta base", "Fuente de financiamiento") |> 
    add_custom_edge(from = "Fuente de financiamiento", "Rubro") |> 
    add_custom_edge(from = "Rubro", "Tipo de recurso") |> 
    render_graph()
```

### Elegir cómo se estructura el gasto

```{r}
create_graph(attr_theme = "lr") |> 
    add_starter_node("Consulta base") |> 
    add_custom_node("Genérica") |> 
    add_custom_node("Subgenérica") |> 
    add_custom_node("Detalle de subgenérica") |> 
    add_custom_node("Específica") |> 
    add_custom_node("Detalle de específica") |> 
    add_custom_edge(from = "Consulta base", "Genérica") |>
    add_custom_edge(from = "Genérica", "Subgenérica") |>
    add_custom_edge(from = "Subgenérica", "Detalle de subgenérica") |>
    add_custom_edge(from = "Detalle de subgenérica", "Específica") |>
    add_custom_edge(from = "Específica", "Detalle de específica") |>
    render_graph()
```

### Elegir dónde se gasta

```{r}
graph_donde_se_gasta <- create_graph(attr_theme = "lr") |> 
    add_starter_node(label = "Consulta base") |> 
    add_custom_node("Departamento meta") |> 
    add_custom_edge(from = "Consulta base", to = "Departamento meta") |> 
    render_graph()

graph_donde_se_gasta
```

### Elegir cuándo se hizo el gasto

```{r}
create_graph(attr_theme = "lr") |> 
    add_starter_node(label = "Consulta base") |> 
    add_custom_node("Trimestre") |> 
    add_custom_node("Mes") |> 
    add_custom_edge(from = "Consulta base", to = "Trimestre") |> 
    add_custom_edge(from = "Consulta base", to = "Mes") |> 
    add_custom_edge(from = "Trimestre", to = "Mes") |> 
    render_graph()
```
